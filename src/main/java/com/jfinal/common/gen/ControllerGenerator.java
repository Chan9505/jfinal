package com.jfinal.common.gen;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.jfinal.kit.StrKit;
import com.jfinal.plugin.activerecord.generator.TableMeta;

public class ControllerGenerator {
	
	Date date = new Date();
	SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
	
    protected String packageTemplate =
        "package %s;%n%n";
    protected String importTemplate =
        "import %s.%s;%n";
    protected String classDefineTemplate =
        "/**%n" +
        " * Generated by lee.  " +sdf.format(date)+
        " %n" +
        " */%n" +
        "public class %s extends BaseActionController<%s> {%n";
    protected String serviceTemplate =
                    "\tprivate %s service = BeanContext.getBean(%s.class);%n%n"
                    + "\tprotected %s getService() {%n"
                    + "\t\treturn service;"
                    + "%n\t}%n";
    protected String modelPackageName;
    protected String controllerPackageName;
    protected String servicePackageName;
    protected String controllerOutputDir;
    protected boolean extendServiceBase = true;
    
    public ControllerGenerator(String modelPackageName,
                    String servicePackageName, String controllerPackageName, String controllerOutputDir) {
        if (StrKit.isBlank(controllerPackageName)) {
            throw new IllegalArgumentException("controllerPackageName can not be blank.");
        }
        if (controllerPackageName.contains("/") || controllerPackageName.contains("\\")) {
            throw new IllegalArgumentException("controllerPackageName error : " + controllerPackageName);
        }
        if (StrKit.isBlank(controllerOutputDir)) {
            throw new IllegalArgumentException("controllerOutputDir can not be blank.");
        }
        this.servicePackageName = servicePackageName;
        System.out.println("=========controllerPackageName:"+controllerPackageName);
        this.controllerPackageName = controllerPackageName;
        this.modelPackageName = modelPackageName;
        this.controllerOutputDir = controllerOutputDir;
    }
    
    public void setGenerateDaoInModel(boolean extendServiceBase) {
        this.extendServiceBase = extendServiceBase;
    }
    
    public void generate(List<TableMeta> tableMetas) {
        System.out.println("Generate controller ...");
        System.out.println("Service Output Dir: " + controllerOutputDir);
        Map<String, String> contentMap = new HashMap<>();
        for (TableMeta tableMeta : tableMetas) {
            System.out.println("name:" + tableMeta.modelName + "Service");
            System.out.println("content:" + genControllerContent(tableMeta));
            contentMap.put(tableMeta.modelName + "Controller", genControllerContent(tableMeta));
        }
        writeToFile(contentMap);
    }
    
    protected String genControllerContent(TableMeta tableMeta) {
        StringBuilder ret = new StringBuilder();
        genPackage(ret);
        genImport(tableMeta, ret);
        genClassDefine(tableMeta, ret);
        genService(tableMeta, ret);
        ret.append(String.format("}%n"));
        return ret.toString();
    }
    
    protected void genPackage(StringBuilder ret) {
        ret.append(String.format(packageTemplate, controllerPackageName));
    }
//    
    protected void genImport(TableMeta tableMeta, StringBuilder ret) {
        ret.append(String.format(importTemplate, modelPackageName, tableMeta.modelName));
        ret.append(String.format(importTemplate, servicePackageName, tableMeta.modelName + "Service"));
        ret.append("import com.jfinal.base.BaseActionController;");
        ret.append("import com.jfinal.utils.BeanContext;");
        ret.append(String.format("%n%n"));
    }
//    
    protected void genClassDefine(TableMeta tableMeta, StringBuilder ret) {
        ret.append(String.format(classDefineTemplate, tableMeta.modelName + "Controller", tableMeta.modelName));
    }
    
    protected void genService(TableMeta tableMeta, StringBuilder ret) {
        if (extendServiceBase) {
            String serviceName = tableMeta.modelName + "Service";
            ret.append(String.format(serviceTemplate, serviceName, serviceName, serviceName));
        } else {
            ret.append(String.format("\t%n"));
        }
    }
    
    protected void writeToFile(Map<String, String> contentMap) {
        try {
            for (String controllerName : contentMap.keySet()) {
                writeToFile(controllerName, contentMap.get(controllerName));
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }
    
    /**
     * 若 controller 文件存在，则不生成，以免覆盖用户手写的代码
     */
    protected void writeToFile(String controllerName, String content) throws IOException {
        File dir = new File(controllerOutputDir);
        if (!dir.exists()) {
            dir.mkdirs();
        }
        
        String target = controllerOutputDir + File.separator + controllerName + ".java";
        
        File file = new File(target);
        if (file.exists()) {
            return ;    // 若 Model 存在，不覆盖
        }
        
        FileWriter fw = new FileWriter(file);
        try {
            fw.write(content);
        }
        finally {
            fw.close();
        }
    }
}
